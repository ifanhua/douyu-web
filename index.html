<!doctype html>
<html lang="zh-Hans-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>斗鱼助手</title>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
            background-color: #f5f6f7;
            font-size: 14px;
        }

        #app {
            margin: 5px;
        }

        #form .form-item label {
            display: inline-block;
            width: 100px;
        }

        #msg span {
            display: inline-block;
        }

        #msg .nn {
            width: 150px;
        }

        #msg .level {
            width: 30px;
        }

        #msg .nl {
            width: 50px;
        }

        #msg .bnn {
            width: 50px;
        }

        #msg .bl {
            width: 30px;
        }
    </style>
</head>

<body>

<div id="app">
    <div id="form">
        <div class="form-item">
            <label for="room">房间号</label>
            <input type="number" id="room" value="485503">
        </div>
        <div class="form-item">
            <label for="danmu">弹幕屏蔽</label>
            <select name="danmu" id="danmu">
                <option value="-1">关闭弹幕</option>
            </select>
        </div>
        <div class="form-item">
            <label for="gift">礼物屏蔽</label>
            <select name="gift" id="gift">
                <option value="-1">关闭礼物</option>
                <option value="0">0元</option>
                <option value="6">6元</option>
                <option value="10">10元</option>
                <option value="50">50元</option>
                <option value="100">100元</option>
                <option value="500">500元</option>
            </select>
        </div>
        <button id="start">开始</button>
        <button id="close">停止</button>
    </div>
    <div id="msg"></div>
</div>

<!-- axios v0.19.2 -->
<script src="./axios.min.js"></script>

<script type="text/javascript">
    var R, // 房间号
        ML = 30, // 是否开启弹幕，屏蔽等级
        GL = 100; // 是否开启礼物，屏蔽价格

    var _room = document.getElementById('room');
    var _danmu = document.getElementById('danmu');
    var _gift = document.getElementById('gift');
    var _start = document.getElementById('start');
    var _close = document.getElementById('close');
    var _msg = document.getElementById('msg');

    var nobleList = {
        1: '骑士',
        2: '子爵',
        3: '伯爵',
        4: '公爵',
        5: '国王',
        6: '皇帝',
        7: '游侠',
        8: '超帝',
        9: '幻神'
    };

    // 原地址为：https://gift.douyucdn.cn，解决跨域问题使用 nginx 反代
    var giftURL = 'https://giftdouyucdn.starudream.cn';

    var giftList = {};

    var ws, alive;

    var c2s = 689; // Client to Server
    var s2c = 690; // Server to Client

    function encode(kv) {
        var buff = [];
        for (var k in kv) {
            if (!kv.hasOwnProperty(k)) continue;
            buff.push(encodeValue(k) + '@=' + encodeValue(kv[k]) + '/');
        }
        return toBuffer(encodeRaw(buff.join('')));
    }

    function encodeRaw(data) {
        return [].concat(
            putUint(9 + data.length, 4),
            putUint(9 + data.length, 4),
            putUint(c2s, 2),
            putUint(0, 1),
            putUint(0, 1),
            putString(data),
            putUint(0, 1)
        );
    }

    function encodeValue(v) {
        v = v.toString();
        v = v.replace('@', '@A');
        v = v.replace('/', '@S');
        return unescape(encodeURIComponent(v));
    }

    function decode(data) {
        var bs = decodeRaw(data);
        if (bs.length === 0) {
            return {};
        }
        var fields = string(bs).split('/');
        var res = {};
        for (var i in fields) {
            if (!fields.hasOwnProperty(i)) continue;
            var kv = fields[i].split('@=');
            if (kv.length !== 2) continue;
            res[decodeValue(kv[0])] = decodeValue(kv[1]);
        }
        return res;
    }

    function decodeRaw(data) {
        if (data.length < 13) {
            return [];
        }
        var l1 = uint(data.slice(0, 4));
        var l2 = uint(data.slice(4, 8));
        if (l1 !== l2 || uint(data.slice(8, 10)) !== s2c || uint(data.slice(10, 11)) !== 0 || uint(data.slice(11, 12)) !== 0) {
            return [];
        }
        return data.slice(12, l1 + 3);
    }

    function decodeValue(v) {
        v = v.toString();
        v = v.replace('@A', '@');
        v = v.replace('@S', '/');
        return decodeURIComponent(escape(v));
    }

    function toBuffer(bs) {
        var ab = new ArrayBuffer(bs.length);
        var dv = new DataView(ab);
        for (var i = 0; i < bs.length; i++) {
            dv.setUint8(i, bs[i]);
        }
        return ab;
    }

    function fromBuffer(ab) {
        var bs = [];
        var dv = new DataView(ab);
        for (var i = 0; i < ab.byteLength; i++) {
            bs[i] = dv.getUint8(i);
        }
        return bs;
    }

    function putUint(v, l) {
        var res = [];
        for (var i = 0; i < l; i++) {
            res[i] = (v >> i * 8) % 256;
        }
        return res;
    }

    function uint(v) {
        var res = 0;
        for (var i = 0; i < v.length; i++) {
            res |= v[i] << i * 8;
        }
        return res;
    }

    function putString(v) {
        var res = [];
        for (var i = 0; i < v.length; i++) {
            res[i] = v.charCodeAt(i);
        }
        return res;
    }

    function string(v) {
        var res = '';
        for (var i = 0; i < v.length; i++) {
            res += String.fromCharCode(v[i]);
        }
        return res;
    }

    function start() {
        console.log('房间号：' + R + '，弹幕等级：' + ML + '，礼物价值：' + GL);

        ws = new WebSocket('wss://danmuproxy.douyu.com:8502/');

        ws.onopen = function () {
            ws.send(encode({ 'type': 'loginreq', 'roomid': R }));
            ws.send(encode({ 'type': 'joingroup', 'rid': R, 'gid': '-9999' }));
            keep();
            initGift();
        };

        ws.onclose = function () {
        };

        ws.onerror = function (ev) {
            console.error(ev);
        };

        ws.onmessage = function (ev) {
            var rd = new FileReader();
            rd.readAsArrayBuffer(ev.data);
            rd.onload = function () {
                var bs = fromBuffer(rd.result);
                for (var i = 0; i < bs.length;) {
                    var len = uint(bs.slice(i, i + 4));
                    var data = decode(bs.slice(i, i + 4 + len));
                    handle(data);
                    i += len + 4;
                }
            };
        };
    }

    function close() {
        clearInterval(alive);
        ws.send(encode({ 'type': 'logout' }));
        setTimeout(function () {
            ws.close();
        }, 1000);
    }

    function keep() {
        ws.send(encode({ 'type': 'mrkl' }));
        alive = setInterval(function () {
            ws.send(encode({ 'type': 'mrkl' }));
        }, 30000);
    }

    function noble(nl) {
        var i = parseInt(nl);
        if (i >= 1 || i <= 9) {
            return nobleList[i];
        }
        return '';
    }

    function initGift() {
        axios
            .get(giftURL + '/api/gift/v2/web/list?rid=' + R)
            .then(function (resp) {
                if (resp.status === 200 && resp.data != null && resp.data.data != null && resp.data.data.giftList != null) {
                    resp.data.data.giftList.forEach(function (v) {
                        giftList['a' + v.id] = { name: v.name, price: v.priceInfo.price };
                    });
                }
            });
    }

    function gift(id, pid) {
        var a = giftList['a' + id];
        if (a != null) {
            return a;
        }
        var b = giftList['b' + pid];
        if (b != null) {
            return b;
        }
        var g = { name: '', price: 0 };
        axios
            .get(giftURL + '/api/prop/v1/web/single?pid=' + pid)
            .then(function (resp) {
                if (resp.status === 200 && resp.data != null && resp.data.data != null) {
                    g.name = resp.data.data.name;
                    g.price = resp.data.data.price;
                    giftList['b' + pid] = g;
                }
            });
        return g;
    }

    function handle(msg) {
        if (msg == null) {
            return;
        }
        setTimeout(function () {
            switch (msg.type) {
                case 'chatmsg':
                    if (ML > -1 && msg.level >= ML) {
                        addMsg(msg.nn, msg.level, noble(msg.nl), msg.bnn, msg.bl, msg.txt);
                    }
                    break;
                case 'dgb':
                    if (GL > -1 && msg.bg) {
                        var g = gift(msg.gfid, msg.pid);
                        if (g.price * msg.hits >= GL * 100) {
                            var txt = g.name + ' ' + msg.gfcnt + ' 个，共 ' + msg.hits + ' 个';
                            addMsg(msg.nn, msg.level, noble(msg.nl), msg.bnn, msg.bl, txt);
                        }
                    }
                    break;
                default:
                    break;
            }
        }, 0);
    }

    function addMsg(nn, level, nl, bnn, bl, txt) {
        if (nl) {
            nl = '[' + nl + ']';
        }
        var p = document.createElement('p');
        p.innerHTML =
            '<span class="nn">' + nn + '</span>' +
            '<span class="level">(' + level + ')</span>' +
            '<span class="nl">' + nl + '</span>' +
            '<span class="bnn">' + bnn + '</span>' +
            '<span class="bl">(' + bl + ')</span>' +
            '<span>: </span>' +
            '<span>' + txt.replace('\n', '') + '</span>';
        _msg.insertBefore(p, _msg.firstChild);
    }

    (function () {
        for (var i = 0; i <= 50; i++) {
            _danmu.options.add(new Option(i + '级', i.toString()));
        }

        _start.onclick = function () {
            if (R == null) {
                R = _room.value;
                if (!R) {
                    alert('房间号为空');
                    return;
                }
                ML = _danmu.value;
                GL = _gift.value;
                _start.disabled = true;
                _close.disabled = false;
                start();
            }
        };

        _close.onclick = function () {
            if (R != null) {
                R = null;
                _start.disabled = false;
                _close.disabled = true;
                close();
            }
        };
    })();
</script>

</body>

</html>
